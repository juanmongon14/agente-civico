<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente C√≠vico ‚Äî Platformer educativo</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#a3b2c2;--text:#e6edf3;--accent:#38bdf8;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--card:#111827;--border:#263043}
    *{box-sizing:border-box}html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:radial-gradient(1200px 600px at 50% -10%,#13223c 10%, #0b1220 60%); color:var(--text); display:flex; align-items:center; justify-content:center}
    .wrap{width:min(1100px,96vw)}
    header{display:flex;justify-content:space-between;align-items:center;margin:16px 0 8px}
    h1{margin:0;font-size:clamp(18px,3vw,26px)}
    .sub{color:var(--muted);font-size:12px}
    .hud{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:8px 0}
    .meter{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
    .meter h3{margin:0 0 6px;font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:center}
    .bar{height:12px;background:#081020;border-radius:8px;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05)}
    .fill{height:100%;width:60%;background:linear-gradient(90deg,var(--ok),#3b82f6);transition:width .3s ease}
    .value{margin-left:auto;font-weight:700;font-size:12px;color:#cbd5e1}
    .panel{display:grid;grid-template-columns:1fr 320px;gap:12px}
    canvas{width:100%;height:auto;display:block;background:#081225;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03)}
    .side{display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
    .log{height:160px;overflow:auto;background:#0f172a;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:13px}
    .btn{appearance:none;border:none;background:var(--accent);color:#062437;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--text)}

    dialog{border:none;border-radius:16px;max-width:min(560px,92vw);padding:0;background:#0b1220;color:var(--text)}
    .modal{padding:18px;border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,#0f172a,#0b1220)}
    .choices{display:grid;gap:8px;margin-top:10px}
    .choice{appearance:none;border:1px solid var(--border);background:#0f172a;color:var(--text);padding:10px;border-radius:12px;text-align:left;cursor:pointer}
    .pill{display:inline-block;background:#0e7490;color:#ecfeff;padding:2px 8px;border-radius:999px;font-size:11px;margin-left:6px}
    .warnbar .fill{background:linear-gradient(90deg,var(--warn),#22c55e)}
    .badbar .fill{background:linear-gradient(90deg,var(--bad),#f59e0b)}

    /* Timeline */
    .timeline{display:grid;gap:8px;max-height:200px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px;background:#0f172a}
    .tl-item{display:flex;gap:8px;align-items:flex-start;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:6px}
    .tl-year{font-weight:800;font-size:12px;color:#a5b4fc}
    .tl-title{font-weight:700;font-size:13px;color:#e2e8f0}
    .tl-cap{font-size:12px;color:#cbd5e1}
    .thumb{width:44px;height:44px;flex:0 0 44px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#0b1220}
    .thumb img{display:block;width:100%;height:100%;object-fit:cover;}

    @media(max-width: 980px){.panel{grid-template-columns:1fr}.log{height:120px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Agente C√≠vico ‚Äî Platformer</h1>
        <div class="sub">Mu√©vete con <b>‚Üê ‚Üí</b> o <b>A D</b>, salta con <b>Espacio</b>, interact√∫a con <b>E</b>. Recoge <b>üß† Datos</b> y evita <b>üö´ Rumores</b>. Llega a la bandera üèÅ manteniendo los indicadores entre <b>35‚Äì85</b>.</div>
      </div>
      <div>
        <button id="btnReiniciar" class="btn ghost">Reiniciar</button>
      </div>
    </header>

    <section class="hud" id="hud">
      <div class="meter" data-key="security"><h3>üõ°Ô∏è Seguridad <span class="value">60</span></h3><div class="bar"><div class="fill" style="width:60%"></div></div></div>
      <div class="meter" data-key="liberty"><h3>üóΩ Libertades <span class="value">60</span></h3><div class="bar"><div class="fill" style="width:60%"></div></div></div>
      <div class="meter" data-key="intl"><h3>üåç Relaciones <span class="value">60</span></h3><div class="bar"><div class="fill" style="width:60%"></div></div></div>
      <div class="meter" data-key="opinion"><h3>üì∞ Opini√≥n <span class="value">60</span></h3><div class="bar"><div class="fill" style="width:60%"></div></div></div>
    </section>

    <section class="panel">
      <canvas id="game" width="960" height="540" aria-label="Agente C√≠vico"></canvas>
      <aside class="side">
        <div class="card">
          <h3 style="margin:0 0 6px">üìí Registro</h3>
          <div id="log" class="log"></div>
        </div>
        <div class="card">
          <h3 style="margin:0">üéØ Objetivo</h3>
          <p style="margin:.5em 0 0;color:#cbd5e1;font-size:13px">Llega a la meta üèÅ con al menos <b>5 datos verificados</b> y sin caer en crisis (0‚Äì15 o 95+ en alg√∫n indicador).</p>
          <p style="margin:.4em 0 0;color:#a8c0ff;font-size:12px">Si te acercas a un <b>terminal</b> üñ•Ô∏è, pulsa <b>E</b> para tomar una decisi√≥n con impacto.</p>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">üï∞Ô∏è L√≠nea de tiempo</h3>
          <div id="timeline" class="timeline"></div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">üèÖ Rol hist√≥rico</h3>
          <p id="roleText" style="margin:.4em 0 0;color:#e2e8f0;font-weight:700">‚Äî</p>
          <p id="roleCap" style="margin:.2em 0 0;color:#cbd5e1;font-size:12px">Equilibra tus decisiones para definir tu perfil.</p>
        </div>
      </aside>
    </section>
  </div>

  <!-- Modal de decisiones / di√°logos -->
  <dialog id="dlg">
    <div class="modal">
      <h3 id="dlgTitle" style="margin:0 0 4px">Decisi√≥n</h3>
      <p id="dlgDesc" style="margin:0 0 8px;color:#cbd5e1">Elige una opci√≥n:</p>
      <div id="dlgChoices" class="choices"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <form method="dialog"><button class="btn ghost">Cerrar</button></form>
      </div>
    </div>
  </dialog>

<script>
(()=>{
  // ===== DOM & base =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const hud = document.getElementById('hud');
  const logEl = document.getElementById('log');
  const btnReiniciar = document.getElementById('btnReiniciar');
  const dlg = document.getElementById('dlg');
  const dlgTitle = document.getElementById('dlgTitle');
  const dlgDesc = document.getElementById('dlgDesc');
  const dlgChoices = document.getElementById('dlgChoices');
  const roleText = document.getElementById('roleText');
  const roleCap = document.getElementById('roleCap');

  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  function resize(){
    const cssW = canvas.clientWidth, cssH = Math.round(cssW*9/16);
    canvas.style.height = cssH+'px';
    canvas.width = Math.floor(cssW * DPR); canvas.height = Math.floor(cssH * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  new ResizeObserver(resize).observe(canvas); resize();

  const G = 0.8; // gravedad
  const FRICTION = 0.85;
  const KEYS = {left:false,right:false,up:false,interact:false};
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const rnd=(n)=>Math.floor(Math.random()*n);

  // ===== Estado de juego =====
  const state = { security:60, liberty:60, intl:60, opinion:60, datos:0, rumores:0, gameOver:false, win:false };
  const meters=['security','liberty','intl','opinion'];

  function updateHUD(){
    meters.forEach(k=>{
      const m = hud.querySelector(`.meter[data-key="${k}"]`);
      const val = Math.round(state[k]);
      m.querySelector('.value').textContent = val;
      m.querySelector('.fill').style.width = val+'%';
      m.classList.toggle('warnbar', (val>25&&val<35)||(val>85&&val<90));
      m.classList.toggle('badbar', val<=25 || val>=90);
    });
  }
  function log(msg){ const div=document.createElement('div'); div.innerHTML=msg; logEl.prepend(div); }

  // ==== TIMELINE con mini infograf√≠as (SVG embebido) ====
  function svgThumb(c1='#38bdf8', c2='#0b1220'){
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
      <rect width='64' height='64' rx='10' fill='${c2}'/>
      <circle cx='20' cy='22' r='10' fill='${c1}'/>
      <rect x='30' y='30' width='26' height='12' rx='3' fill='${c1}'/>
      <path d='M8 46h48v6H8z' fill='${c1}'/>
    </svg>`;
    return 'data:image/svg+xml;base64,'+btoa(svg);
  }
  const TL = [
    {id:'11s', year:'2001', title:'Atentados del 11 de septiembre', cap:'Punto de quiebre para pol√≠ticas de seguridad.', img:svgThumb('#ef4444','#0b1220')},
    {id:'patriot', year:'2001', title:'USA PATRIOT Act', cap:'Ampl√≠a facultades de vigilancia e inteligencia.', img:svgThumb('#38bdf8','#0b1220')},
    {id:'guantanamo', year:'2002', title:'Guant√°namo', cap:'Debate global sobre DD.HH. y detenciones.', img:svgThumb('#f59e0b','#0b1220')},
    {id:'alianzas', year:'2002‚Äì2005', title:'Alianzas de inteligencia', cap:'Cooperaci√≥n internacional contra redes extremistas.', img:svgThumb('#22c55e','#0b1220')},
    {id:'reformas', year:'2015+', title:'Reformas y supervisi√≥n', cap:'L√≠mites a programas masivos y mayor control.', img:svgThumb('#a78bfa','#0b1220')}
  ];
  let TL_UNLOCK = new Set();
  function renderTimeline(){
    const box = document.getElementById('timeline');
    if(!box) return; box.innerHTML='';
    TL.filter(item=>TL_UNLOCK.has(item.id)).forEach(item=>{
      const el = document.createElement('div'); el.className='tl-item';
      el.innerHTML = `<div class='thumb'><img alt='${item.title}' src='${item.img}'/></div>
        <div>
          <div class='tl-year'>${item.year}</div>
          <div class='tl-title'>${item.title}</div>
          <div class='tl-cap'>${item.cap}</div>
        </div>`;
      box.appendChild(el);
    });
  }
  function unlock(id){ if(!TL_UNLOCK.has(id)){ TL_UNLOCK.add(id); renderTimeline(); } }

  // ==== CONTENIDO HIST√ìRICO EDUCATIVO ====
  const HISTORIA = {
    vigilancia: "Tras los eventos del 11 de septiembre de 2001, EE.UU. aprob√≥ la Ley Patriota, autorizando vigilancia ampliada y recopilaci√≥n masiva de datos para prevenir ataques. Esto gener√≥ debate sobre privacidad vs seguridad.",
    refugiados: "Despu√©s de 2001, pol√≠ticas migratorias y de refugiados se endurecieron en EE.UU. y otros pa√≠ses. Algunos argumentaron que era necesario por seguridad; otros se√±alaron discriminaci√≥n y el deber humanitario.",
    poderes: "En situaciones de emergencia, gobiernos pueden solicitar poderes extraordinarios. En EE.UU., tras 2001, hubo ampliaci√≥n de poderes ejecutivos y uso militar en el extranjero, generando debates sobre l√≠mites democr√°ticos."
  };

  // ===== Mundo / nivel =====
  const level = {
    width: 3000,
    height: 540,
    groundY: 420,
    platforms: [
      {x:0,y:420,w:800,h:120},
      {x:820,y:360,w:240,h:30},
      {x:1120,y:300,w:180,h:30},
      {x:1400,y:420,w:400,h:120},
      {x:1820,y:360,w:240,h:30},
      {x:2100,y:320,w:220,h:30},
      {x:2400,y:420,w:600,h:120},
    ],
    datos: [
      {x:180,y:360}, {x:560,y:360}, {x:870,y:320}, {x:1150,y:260}, {x:1500,y:360}, {x:1850,y:320}, {x:2130,y:280}, {x:2460,y:360}
    ],
    rumores: [
      {x:700,y:392}, {x:1320,y:392}, {x:1680,y:392}, {x:2050,y:292}, {x:2280,y:392}
    ],
    terminales: [
      {x:980,y:330, id:'vigilancia'},
      {x:1600,y:330, id:'refugiados'},
      {x:2550,y:330, id:'poderes'}
    ],
    npcs: [
      {x:620, kind:'periodista', text:'¬øTransparencia estatal? La gente necesita respuestas claras.'},
      {x:1450, kind:'ciudadano', text:'Quiero seguridad, pero no perder mis derechos.'},
      {x:2200, kind:'oficial', text:'Los operativos necesitan marco legal y apoyo p√∫blico.'}
    ],
    meta:{x:2920,y:350}
  };

  // ===== Personaje =====
  const player = { x:40, y: level.groundY-48, w: 32, h: 48, vx:0, vy:0, speed:4.2, jump:-16, grounded:false };
  const camera = {x:0,y:0};

  // ===== Decisiones =====
  const DECISIONES = {
    vigilancia: {
      title:'Programa de vigilancia',
      desc:'¬øRenovar vigilancia digital para detectar amenazas? ',
      opciones:[
        {txt:'Renovar con l√≠mites y supervisi√≥n judicial', eff:{security:+4, liberty:+3, intl:+1, opinion:+2}},
        {txt:'Renovar sin cambios', eff:{security:+7, liberty:-8, intl:-1, opinion:-3}},
        {txt:'No renovar', eff:{security:-5, liberty:+6, intl:+1, opinion:+3}},
      ]
    },
    refugiados: {
      title:'Pol√≠tica de refugiados',
      desc:'Se eval√∫an requisitos de ingreso en contexto de alerta.',
      opciones:[
        {txt:'Vetting robusto y cuotas moderadas', eff:{security:+3, liberty:+2, intl:+2, opinion:+1}},
        {txt:'Endurecer requisitos temporalmente', eff:{security:+5, liberty:-3, intl:-2, opinion:+1}},
        {txt:'Ampliar cuotas sin cambios', eff:{security:-3, liberty:+4, intl:+3, opinion:+2}},
      ]
    },
    poderes: {
      title:'Poderes de emergencia',
      desc:'Proponen extender poderes ejecutivos extraordinarios 1 a√±o.',
      opciones:[
        {txt:'Extender con control legislativo', eff:{security:+3, liberty:+2, intl:+1, opinion:+2}},
        {txt:'Extender sin cambios', eff:{security:+5, liberty:-7, intl:-1, opinion:-2}},
        {txt:'No extender', eff:{security:-3, liberty:+5, intl:+1, opinion:+1}},
      ]
    }
  };

  // ===== Input =====
  window.addEventListener('keydown', e=>{
    if(['ArrowLeft','KeyA'].includes(e.code)) KEYS.left=true;
    if(['ArrowRight','KeyD'].includes(e.code)) KEYS.right=true;
    if(e.code==='Space') { KEYS.up=true; e.preventDefault(); }
    if(e.code==='KeyE') KEYS.interact=true;
  });
  window.addEventListener('keyup', e=>{
    if(['ArrowLeft','KeyA'].includes(e.code)) KEYS.left=false;
    if(['ArrowRight','KeyD'].includes(e.code)) KEYS.right=false;
    if(e.code==='Space') KEYS.up=false;
    if(e.code==='KeyE') KEYS.interact=false;
  });

  // ===== Utilidades colisi√≥n =====
  function rectsOverlap(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

  // ===== Di√°logos =====
  function abrirDialogoDecision(terminal){
    const data = DECISIONES[terminal.id];
    dlgTitle.textContent = data.title;
    dlgDesc.innerHTML = `<b>Contexto hist√≥rico:</b><br>${HISTORIA[terminal.id]}<br><br>${data.desc}`;
    dlgChoices.innerHTML = '';
    data.opciones.forEach(opt=>{
      const b=document.createElement('button'); b.className='choice'; b.innerHTML = `${opt.txt} <span class='pill'>impacto</span>`;
      b.onclick=()=>{ aplicarEfectos(opt.eff); dlg.close(); log(`<b>${data.title}:</b> ${opt.txt}`);
        if(terminal.id==='vigilancia') unlock('patriot');
        if(terminal.id==='refugiados') unlock('alianzas');
        if(terminal.id==='poderes') unlock('reformas');
        terminal.resuelto=true;
      };
      dlgChoices.appendChild(b);
    });
    dlg.showModal();
  }
  function abrirDialogoNPC(n){
    dlgTitle.textContent = n.kind==='periodista'? 'Periodista' : n.kind==='ciudadano'? 'Ciudadano' : 'Oficial';
    dlgDesc.textContent = n.text;
    dlgChoices.innerHTML='';
    const opciones=[
      {txt:'Explicar derechos y protocolos', eff:{liberty:+2, opinion:+1}},
      {txt:'Prometer resultados con datos', eff:{opinion:+2, intl:+1}},
      {txt:'Evitar comentario', eff:{opinion:-1}}
    ];
    opciones.forEach(o=>{ const b=document.createElement('button'); b.className='choice'; b.textContent=o.txt; b.onclick=()=>{ aplicarEfectos(o.eff); dlg.close(); log(`<b>Di√°logo:</b> ${o.txt}`); unlock('11s'); }; dlgChoices.appendChild(b); });
    dlg.showModal();
  }

  function aplicarEfectos(eff){
    const jitter = ()=> (Math.random()<0.35?1:0);
    meters.forEach(k=>{ state[k] = clamp(state[k] + (eff[k]||0) + jitter(), 0, 100); });
    updateHUD();
    if(meters.some(k=>state[k]<=15) || meters.some(k=>state[k]>=95)){
      state.gameOver=true; log(`<span style='color:#fca5a5'>Crisis: un indicador sali√≥ de rango.</span>`);
    }
  }

  // ===== Loop =====
  function reiniciar(){
    Object.assign(state,{security:60,liberty:60,intl:60,opinion:60,datos:0,rumores:0,gameOver:false,win:false});
    Object.assign(player,{x:40,y:level.groundY-48,vx:0,vy:0,grounded:false});
    level.terminales.forEach(t=>t.resuelto=false);
    TL_UNLOCK = new Set(); renderTimeline(); roleText.textContent='‚Äî'; roleCap.textContent='Equilibra tus decisiones para definir tu perfil.';
    updateHUD(); logEl.innerHTML=''; unlock('11s');
  }
  btnReiniciar.addEventListener('click', reiniciar);

  let terminalCercano=null, npcCercano=null;
  function update(){
    if(state.gameOver || state.win) return;

    // movimiento
    const ax = (KEYS.left?-player.speed:0) + (KEYS.right?player.speed:0);
    player.vx = ax ? ax : player.vx * FRICTION;
    if(Math.abs(player.vx)<0.1) player.vx=0;

    if(KEYS.up && player.grounded){ player.vy = player.jump; player.grounded=false; }
    player.vy += G;

    // aplicar movimiento
    player.x += player.vx; player.y += player.vy;
    player.x = clamp(player.x, 0, level.width - player.w);

    // suelo base
    if(player.y + player.h > level.groundY){ player.y = level.groundY - player.h; player.vy = 0; player.grounded=true; }

    // plataformas
    level.platforms.forEach(p=>{
      const r={x:p.x,y:p.y,w:p.w,h:p.h};
      const me={x:player.x,y:player.y,w:player.w,h:player.h};
      if(rectsOverlap(me,r)){
        if(me.y+me.h- player.vy <= r.y+8){ player.y = r.y - me.h; player.vy=0; player.grounded=true; }
        else if(me.y - player.vy >= r.y + r.h - 8){ player.y = r.y + r.h; player.vy = 0.5; }
        else if(me.x < r.x){ player.x = r.x - me.w; player.vx=0; }
        else{ player.x = r.x + r.w; player.vx=0; }
      }
    });

    // c√°mara
    camera.x = clamp(player.x - canvas.width/(DPR*2) + player.w/2, 0, level.width - canvas.width/DPR);
    camera.y = 0;

    // datos
    for(let i=level.datos.length-1;i>=0;i--){
      const d = level.datos[i];
      const r={x:d.x,y:d.y,w:18,h:18};
      const me={x:player.x,y:player.y,w:player.w,h:player.h};
      if(rectsOverlap(me,r)){
        level.datos.splice(i,1); state.datos++; log('Has verificado un <b>dato</b> üß† (+confianza)');
        aplicarEfectos({opinion:+1, intl:+1});
        if(state.datos===1) unlock('11s');
        if(state.datos===3) unlock('guantanamo');
        if(state.datos===5) unlock('reformas');
      }
    }

    // rumores
    for(const r of level.rumores){
      const box={x:r.x,y:r.y,w:22,h:22};
      const me={x:player.x,y:player.y,w:player.w,h:player.h};
      if(rectsOverlap(me,box)){
        r.x += 9999; // one-shot
        log('<span style="color:#fca5a5">Tocaste un <b>rumor</b> üö´ (impacto negativo)</span>');
        aplicarEfectos({opinion:-2, intl:-1});
      }
    }

    // terminal cercano
    terminalCercano = null;
    for(const t of level.terminales){
      const box={x:t.x,y:level.groundY-60,w:26,h:60};
      const me={x:player.x,y:player.y,w:player.w,h:player.h};
      if(!t.resuelto && rectsOverlap(me,{x:box.x-10,y:box.y,w:box.w+20,h:box.h})) { terminalCercano = t; break; }
    }
    if(terminalCercano && KEYS.interact){ abrirDialogoDecision(terminalCercano); }

    // NPC cercano
    npcCercano = null;
    for(const n of level.npcs){
      const box={x:n.x,y:level.groundY-56,w:26,h:56};
      const me={x:player.x,y:player.y,w:player.w,h:player.h};
      if(rectsOverlap(me,{x:box.x-12,y:box.y,w:box.w+24,h:box.h})) { npcCercano=n; break; }
    }
    if(npcCercano && KEYS.interact){ abrirDialogoNPC(npcCercano); }

    // meta
    const metaR = {x:level.meta.x,y:level.groundY-88,w:18,h:88};
    if(rectsOverlap({x:player.x,y:player.y,w:player.w,h:player.h}, metaR)){
      if(state.datos>=5 && !state.gameOver){ state.win=true; log('<b>¬°Meta alcanzada!</b> üèÅ'); evaluarRol(); }
      else { log('Te falta evidencia üß† para terminar. Consigue m√°s.'); }
    }

    // caer fuera
    if(player.y> level.height){ state.gameOver=true; log('<span style="color:#fca5a5">Ca√≠ste fuera de la zona segura.</span>'); }
  }

  function evaluarRol(){
    const s=state.security, l=state.liberty, i=state.intl, o=state.opinion;
    let role='Analista', cap='Balanceas evidencia y decisiones prudentes.';
    if(s>=75 && l<=65) { role='Halc√≥n'; cap='Prioriza seguridad y respuesta r√°pida, con costos civiles.'; }
    else if(l>=75 && s>=45) { role='Guardi√°n Constitucional'; cap='Defiendes libertades y controles institucionales.'; }
    else if(i>=72 && o>=55) { role='Diplom√°tico'; cap='Construyes alianzas y legitimidad internacional.'; }
    else if(Math.abs(s-60)+Math.abs(l-60)+Math.abs(i-60)+Math.abs(o-60) < 40) { role='Analista'; cap='Buscas el centro con datos y evaluaci√≥n de riesgos.'; }
    roleText.textContent = role; roleCap.textContent = cap; log(`<b>Perfil:</b> ${role}`);
  }

  // ===== Render =====
  function draw(){
    ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
    const W = canvas.width/DPR, H=canvas.height/DPR;

    // fondo
    ctx.fillStyle = '#071022'; ctx.fillRect(0,0,W,H);
    drawStars(0.6, 0.3);

    ctx.save(); ctx.translate(-camera.x, -camera.y);

    // suelo
    ctx.fillStyle = '#0b1936'; ctx.fillRect(0, level.groundY, level.width, H-level.groundY);

    // plataformas
    ctx.fillStyle = '#15305f';
    for(const p of level.platforms){ ctx.fillRect(p.x, p.y, p.w, p.h); }

    // terminales
    for(const t of level.terminales){ drawTerminal(t); }

    // NPCs
    for(const n of level.npcs){ drawNPC(n); }

    // datos
    for(const d of level.datos){ ctx.fillStyle='#7ee787'; ctx.fillRect(d.x,d.y,18,18); ctx.fillStyle='#0a2a18'; ctx.fillRect(d.x+4,d.y+4,10,10); }

    // rumores
    for(const r of level.rumores){ ctx.fillStyle='#ef4444'; ctx.fillRect(r.x,r.y,22,22); ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fillRect(r.x+4,r.y+4,14,14); }

    // meta
    drawFlag(level.meta.x, level.groundY);

    // jugador
    drawPlayer();

    // prompts
    if(terminalCercano){ ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='bold 14px system-ui'; ctx.fillText('Pulsa E para decidir', terminalCercano.x-20, level.groundY-68); }
    if(npcCercano){ ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='bold 14px system-ui'; ctx.fillText('Pulsa E para hablar', npcCercano.x-16, level.groundY-70); }

    ctx.restore();

    if(state.gameOver || state.win){
      const boxW=360, boxH=120; const x=(W-boxW)/2, y=(H-boxH)/2;
      ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(x,y,boxW,boxH);
      ctx.fillStyle='#e6edf3'; ctx.font='bold 20px system-ui';
      ctx.fillText(state.win? '¬°Victoria c√≠vica! üèÅ': 'Fin del juego', x+20, y+40);
      ctx.font='14px system-ui';
      ctx.fillText(state.win? 'Mantuviste el equilibrio y llegaste a la meta.' : 'Se produjo una crisis o ca√≠ste fuera del mundo.', x+20, y+66);
      ctx.fillText('Pulsa ‚ÄúReiniciar‚Äù para jugar de nuevo.', x+20, y+92);
    }
  }

  function drawStars(a=0.6,b=0.3){
    ctx.save();
    for(let i=0;i<80;i++){
      const x=((i*37.7)%canvas.width)/DPR; const y=((i*91.3)%canvas.height)/DPR * a + 10;
      ctx.fillStyle='rgba(180,210,255,'+b+')'; ctx.fillRect(x,y,1,1);
    }
    ctx.restore();
  }
  function drawTerminal(t){
    const x=t.x, y=level.groundY-60;
    ctx.fillStyle = t.resuelto? '#227d3b' : '#3b82f6';
    ctx.fillRect(x, y, 26, 60);
    ctx.fillStyle = '#0b1220'; ctx.fillRect(x+5, y+8, 16, 12);
    ctx.fillStyle = 'rgba(255,255,255,.18)'; ctx.fillRect(x+5, y+28, 16, 4); ctx.fillRect(x+5, y+36, 16, 4);
  }
  function drawNPC(n){
    const x=n.x, y=level.groundY-52;
    ctx.fillStyle = n.kind==='periodista'? '#334155' : n.kind==='ciudadano'? '#0b2545' : '#1d4ed8';
    ctx.fillRect(x, y, 22, 46);
    ctx.fillStyle='#f1c27d'; ctx.fillRect(x+4, y-10, 14, 10);
    if(n.kind==='periodista'){ ctx.fillStyle='#a3e635'; ctx.fillRect(x+3, y+8, 16, 8); }
    if(n.kind==='oficial'){ ctx.fillStyle='#93c5fd'; ctx.fillRect(x+16, y+16, 6, 10); }
  }
  function drawFlag(x, groundY){ ctx.fillStyle='#eab308'; ctx.fillRect(x, groundY-88, 6, 88); ctx.fillStyle='#38bdf8'; ctx.beginPath(); ctx.moveTo(x+6, groundY-84); ctx.lineTo(x+54, groundY-74); ctx.lineTo(x+6, groundY-64); ctx.closePath(); ctx.fill(); }
  function drawPlayer(){
    const px=player.x, py=player.y;
    // Piernas
    ctx.fillStyle='#0f172a'; ctx.fillRect(px+6, py+32, 8, 16); ctx.fillRect(px+18, py+32, 8, 16);
    ctx.fillStyle='#1f2937'; ctx.fillRect(px+6, py+48, 10, 4); ctx.fillRect(px+18, py+48, 10, 4);
    // Torso con saco
    ctx.fillStyle='#0b2545'; ctx.fillRect(px, py, player.w, 34);
    // Camisa
    ctx.fillStyle='#e2e8f0'; ctx.fillRect(px+6, py+4, player.w-12, 14);
    // Corbata
    ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.moveTo(px+player.w/2, py+6); ctx.lineTo(px+player.w/2-4, py+16); ctx.lineTo(px+player.w/2+4, py+16); ctx.closePath(); ctx.fill(); ctx.fillRect(px+player.w/2-2, py+16, 4, 10);
    // Cabeza
    ctx.fillStyle='#f1c27d'; ctx.fillRect(px+6, py-12, player.w-12, 12);
    ctx.fillStyle='#1f2937'; ctx.fillRect(px+6, py-14, player.w-12, 6);
    // Tablet
    ctx.fillStyle='#38bdf8'; ctx.fillRect(px+player.w-6, py+18, 6, 10);
    // Sombra
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(px, py+player.h, player.w, 4);
  }

  function loop(){ update(); draw(); requestAnimationFrame(loop); }

  // init
  reiniciar();
  loop();
})();
</script>
</body>
</html>
